// ================================
// ARREGLO ESPEC√çFICO PARA BOTONES DE MODALES
// ================================

console.log('üîß Iniciando arreglo de botones de modales...');

// Funci√≥n para diagnosticar y arreglar todos los eventos de modales
function fixModalButtonEvents() {
    console.log('üîç === DIAGN√ìSTICO DE BOTONES DE MODALES ===');
    
    // Lista de todos los botones de modales que necesitan eventos
    const modalButtons = [
        // Botones de confirmaci√≥n de venta
        { id: 'confirm-sale-btn', action: 'confirmSale', context: 'cashRegister' },
        { id: 'cancel-sale-modal-btn', action: 'cancelSaleModal', context: 'cashRegister' },
        
        // Botones de movimiento de efectivo
        { id: 'confirm-movement-btn', action: 'confirmCashMovement', context: 'cashRegister' },
        { id: 'cancel-movement-btn', action: 'cancelCashMovement', context: 'cashRegister' },
        
        // Botones de cierre de caja
        { id: 'confirm-close-btn', action: 'confirmCloseCash', context: 'cashRegister' },
        { id: 'cancel-close-btn', action: 'cancelCloseCash', context: 'cashRegister' }
    ];
    
    // Funci√≥n para limpiar y reestablecer eventos
    function reestablishButtonEvents() {
        modalButtons.forEach(buttonConfig => {
            const button = document.getElementById(buttonConfig.id);
            
            if (button) {
                console.log(`‚úÖ Encontrado bot√≥n: ${buttonConfig.id}`);
                
                // Limpiar todos los eventos previos
                const newButton = button.cloneNode(true);
                button.parentNode.replaceChild(newButton, button);
                
                // Agregar el nuevo evento
                const finalButton = document.getElementById(buttonConfig.id);
                
                finalButton.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    
                    console.log(`üîÑ Ejecutando acci√≥n: ${buttonConfig.action}`);
                    
                    // Ejecutar la acci√≥n correspondiente
                    if (buttonConfig.context === 'cashRegister' && window.cashRegister) {
                        if (typeof window.cashRegister[buttonConfig.action] === 'function') {
                            window.cashRegister[buttonConfig.action]();
                        } else {
                            console.error(`‚ùå Funci√≥n no encontrada: ${buttonConfig.action}`);
                        }
                    } else if (buttonConfig.context === 'inventory' && window.inventoryManager) {
                        if (typeof window.inventoryManager[buttonConfig.action] === 'function') {
                            window.inventoryManager[buttonConfig.action]();
                        }
                    }
                });
                
                console.log(`‚úÖ Evento reestablecido para: ${buttonConfig.id}`);
            } else {
                console.log(`‚ö†Ô∏è Bot√≥n no encontrado: ${buttonConfig.id}`);
            }
        });
    }
    
    // Funci√≥n especial para manejar formularios din√°micos de productos
    function fixProductFormEvents() {
        // Observer para detectar cuando se crean formularios de productos
        const observer = new MutationObserver(function(mutations) {
            mutations.forEach(function(mutation) {
                mutation.addedNodes.forEach(function(node) {
                    if (node.nodeType === 1) { // Element node
                        // Buscar formularios de productos
                        const productForm = node.querySelector ? node.querySelector('.product-form') : null;
                        if (productForm || (node.classList && node.classList.contains('product-form'))) {
                            console.log('üìù Formulario de producto detectado, configurando eventos...');
                            setupProductFormEvents(productForm || node);
                        }
                        
                        // Buscar modal gen√©rico
                        const modal = node.querySelector ? node.querySelector('.modal') : null;
                        if (modal || (node.classList && node.classList.contains('modal'))) {
                            setTimeout(() => {
                                console.log('üì± Modal detectado, reestableciendo eventos...');
                                reestablishButtonEvents();
                                fixFormSubmissions();
                            }, 100);
                        }
                    }
                });
            });
        });
        
        // Observar cambios en el DOM
        observer.observe(document.body, {
            childList: true,
            subtree: true
        });
        
        console.log('üëÅÔ∏è Observer de formularios activado');
    }
    
    function setupProductFormEvents(form) {
        if (!form) return;
        
        // Manejar env√≠o del formulario
        form.addEventListener('submit', function(e) {
            e.preventDefault();
            e.stopPropagation();
            
            console.log('üì§ Enviando formulario de producto...');
            
            const formData = new FormData(form);
            const data = Object.fromEntries(formData);
            
            // Determinar si es agregar o editar
            const isEdit = form.dataset.productId || form.querySelector('[name="id"]');
            
            if (isEdit) {
                const productId = form.dataset.productId || form.querySelector('[name="id"]').value;
                if (window.inventoryManager && typeof window.inventoryManager.handleEditProduct === 'function') {
                    window.inventoryManager.handleEditProduct(productId, data);
                }
            } else {
                if (window.inventoryManager && typeof window.inventoryManager.handleAddProduct === 'function') {
                    window.inventoryManager.handleAddProduct(data);
                }
            }
        });
        
        // Manejar bot√≥n cancelar
        const cancelBtn = form.querySelector('.action-btn.secondary');
        if (cancelBtn) {
            cancelBtn.addEventListener('click', function(e) {
                e.preventDefault();
                e.stopPropagation();
                console.log('‚ùå Cancelando formulario de producto...');
                if (window.uiManager && typeof window.uiManager.closeModal === 'function') {
                    window.uiManager.closeModal();
                }
            });
        }
        
        console.log('‚úÖ Eventos de formulario de producto configurados');
    }
    
    function fixFormSubmissions() {
        // Arreglar todos los formularios din√°micos
        const forms = document.querySelectorAll('.product-form, .dynamic-form');
        forms.forEach(form => {
            if (!form.dataset.eventsFixed) {
                setupProductFormEvents(form);
                form.dataset.eventsFixed = 'true';
            }
        });
    }
    
    // Funci√≥n para arreglar eventos globales de modales
    function fixGlobalModalEvents() {
        // Manejar todos los botones con onclick directo
        const buttonsWithOnclick = document.querySelectorAll('button[onclick], .action-btn[onclick]');
        buttonsWithOnclick.forEach(button => {
            const onclickValue = button.getAttribute('onclick');
            if (onclickValue && onclickValue.includes('closeModal')) {
                // Reemplazar onclick con event listener
                button.removeAttribute('onclick');
                button.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    
                    if (window.uiManager && typeof window.uiManager.closeModal === 'function') {
                        window.uiManager.closeModal();
                    }
                });
                console.log('‚úÖ Evento onclick convertido a addEventListener para bot√≥n');
            }
        });
    }
    
    // Funci√≥n de prueba para verificar que todo funcione
    window.testModalButtons = function() {
        console.log('üß™ === PRUEBA DE BOTONES DE MODALES ===');
        
        modalButtons.forEach(buttonConfig => {
            const button = document.getElementById(buttonConfig.id);
            if (button) {
                console.log(`‚úÖ ${buttonConfig.id}: Disponible`);
                
                // Simular hover para verificar que responde
                button.style.transform = 'scale(1.05)';
                setTimeout(() => {
                    button.style.transform = '';
                }, 200);
            } else {
                console.log(`‚ùå ${buttonConfig.id}: No encontrado`);
            }
        });
    };
    
    // Ejecutar todas las correcciones
    console.log('üîÑ Reestableciendo eventos de botones...');
    reestablishButtonEvents();
    
    console.log('üìù Configurando manejo de formularios din√°micos...');
    fixProductFormEvents();
    
    console.log('üåê Arreglando eventos globales...');
    fixGlobalModalEvents();
    
    console.log('üìã Arreglando formularios existentes...');
    fixFormSubmissions();
    
    console.log('üîß Arreglando formularios din√°micos...');
    fixDynamicFormButtons();
    
    // Nueva funci√≥n para arreglar botones de formularios din√°micos espec√≠ficamente
    function fixDynamicFormButtons() {
        console.log('üîß Arreglando botones de formularios din√°micos...');
        
        const dynamicForms = document.querySelectorAll('.dynamic-form');
        dynamicForms.forEach(form => {
            if (form.dataset.buttonEventsFixed === 'true') {
                console.log('‚ö†Ô∏è Eventos ya configurados para este formulario din√°mico');
                return;
            }
            
            // Marcar como configurado
            form.dataset.buttonEventsFixed = 'true';
            
            // Encontrar botones submit y cancel
            const submitBtn = form.querySelector('button[type="submit"], .action-btn.primary');
            const cancelBtn = form.querySelector('button[type="button"], .action-btn.secondary, #cancel-form');
            
            if (submitBtn) {
                console.log('üîç Arreglando bot√≥n submit en formulario din√°mico...');
                
                // Limpiar eventos previos
                const newSubmitBtn = submitBtn.cloneNode(true);
                submitBtn.parentNode.replaceChild(newSubmitBtn, submitBtn);
                
                // Agregar nuevo evento
                const finalSubmitBtn = form.querySelector('button[type="submit"], .action-btn.primary');
                if (finalSubmitBtn) {
                    finalSubmitBtn.addEventListener('click', function(e) {
                        e.preventDefault();
                        e.stopPropagation();
                        
                        console.log('üì§ Bot√≥n submit clickeado, activando env√≠o de formulario...');
                        
                        // Activar env√≠o del formulario
                        const submitEvent = new Event('submit', {
                            bubbles: true,
                            cancelable: true
                        });
                        form.dispatchEvent(submitEvent);
                    });
                    console.log('‚úÖ Evento submit reestablecido para formulario din√°mico');
                }
            }
            
            if (cancelBtn) {
                console.log('üîç Arreglando bot√≥n cancel en formulario din√°mico...');
                
                // Limpiar eventos previos
                const newCancelBtn = cancelBtn.cloneNode(true);
                cancelBtn.parentNode.replaceChild(newCancelBtn, cancelBtn);
                
                // Agregar nuevo evento
                const finalCancelBtn = form.querySelector('button[type="button"], .action-btn.secondary, #cancel-form');
                if (finalCancelBtn) {
                    finalCancelBtn.addEventListener('click', function(e) {
                        e.preventDefault();
                        e.stopPropagation();
                        
                        console.log('‚ùå Bot√≥n cancelar clickeado, cerrando modal...');
                        
                        if (window.uiManager && typeof window.uiManager.closeModal === 'function') {
                            window.uiManager.closeModal();
                        }
                    });
                    console.log('‚úÖ Evento cancel reestablecido para formulario din√°mico');
                }
            }
        });
        
        console.log('‚úÖ Botones de formularios din√°micos arreglados');
    }

    // Re-ejecutar cada vez que se abra un modal
    const originalShowModal = window.uiManager?.showModal;
    if (originalShowModal) {
        window.uiManager.showModal = function(...args) {
            const result = originalShowModal.apply(this, args);
            
            // Reestablecer eventos despu√©s de mostrar modal
            setTimeout(() => {
                console.log('üîÑ Modal abierto, reestableciendo eventos...');
                reestablishButtonEvents();
                fixFormSubmissions();
                fixDynamicFormButtons();
            }, 150);
            
            return result;
        };
        console.log('üéØ Interceptor de showModal configurado');
    }
    
    console.log('‚úÖ TODOS LOS BOTONES DE MODALES ARREGLADOS');
    console.log('üß™ Para probar ejecuta: testModalButtons()');
    
    return true;
}

// Ejecutar cuando todo est√© cargado
if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', () => {
        setTimeout(fixModalButtonEvents, 200);
    });
} else {
    setTimeout(fixModalButtonEvents, 200);
}

// Reinicializar cuando se cambien las secciones
document.addEventListener('sectionChanged', () => {
    setTimeout(fixModalButtonEvents, 100);
});

// Exponer funciones globalmente para debugging
window.fixModalButtonEvents = fixModalButtonEvents; 